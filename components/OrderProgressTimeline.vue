<!-- components/OrderProgressTimeline.vue -->
<template>
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">
        {{ t.orderProgress }}
      </h2>
    </div>

    <div class="p-4 sm:p-6">
      <!-- Progress Steps -->
      <div class="relative">
        <!-- Vertical line -->
        <div
          class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"
          aria-hidden="true"
        ></div>

        <!-- Steps -->
        <div class="space-y-6 relative">
          <!-- Step 1: Collecting (Productos Agregados) -->
          <div class="flex items-start gap-4">
            <div class="relative flex-shrink-0">
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center',
                  true ? 'bg-primary-600' : 'bg-gray-200',
                ]"
              >
                <svg
                  v-if="true"
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <div v-else class="w-3 h-3 rounded-full bg-white"></div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p
                :class="[
                  'text-sm font-medium',
                  true ? 'text-gray-900' : 'text-gray-500',
                ]"
              >
                {{ t.itemsAdded }}
              </p>
              <p
                :class="[
                  'text-xs mt-0.5',
                  true ? 'text-gray-600' : 'text-gray-400',
                ]"
              >
                {{
                  order.items?.length
                    ? `${order.items.length} ${t.itemsAddedCount}`
                    : t.noItemsYet
                }}
              </p>
            </div>
          </div>

          <!-- Step 2: Order Created (Orden Creada) -->
          <div class="flex items-start gap-4">
            <div class="relative flex-shrink-0">
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center',
                  order.created_at ? 'bg-primary-600' : 'bg-gray-200',
                ]"
              >
                <svg
                  v-if="order.created_at"
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <div v-else class="w-3 h-3 rounded-full bg-white"></div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p
                :class="[
                  'text-sm font-medium',
                  order.created_at ? 'text-gray-900' : 'text-gray-500',
                ]"
              >
                {{ t.orderCreated }}
              </p>
              <p
                v-if="order.created_at"
                class="text-xs text-gray-600 mt-0.5"
              >
                {{ formatDate(order.created_at) }}
              </p>
              <p v-else class="text-xs text-gray-400 mt-0.5">
                {{ t.pending }}
              </p>
            </div>
          </div>

          <!-- Step 3: Packages at Warehouse (Paquetes en Almacén) -->
          <div class="flex items-start gap-4">
            <div class="relative flex-shrink-0">
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center',
                  isStatusReached('packages_complete')
                    ? 'bg-primary-600'
                    : 'bg-gray-200',
                ]"
              >
                <svg
                  v-if="isStatusReached('packages_complete')"
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <div
                  v-else-if="order.status === 'awaiting_packages'"
                  class="w-3 h-3 rounded-full bg-amber-400 animate-pulse"
                ></div>
                <div v-else class="w-3 h-3 rounded-full bg-white"></div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p
                :class="[
                  'text-sm font-medium',
                  isStatusReached('packages_complete')
                    ? 'text-gray-900'
                    : 'text-gray-500',
                ]"
              >
                {{ t.packagesAtWarehouse }}
              </p>
              <p
                :class="[
                  'text-xs mt-0.5',
                  isStatusReached('packages_complete')
                    ? 'text-gray-600'
                    : order.status === 'awaiting_packages'
                    ? 'text-amber-600'
                    : 'text-gray-400',
                ]"
              >
                {{
                  isStatusReached("packages_complete")
                    ? t.allPackagesReceived
                    : order.status === "awaiting_packages"
                    ? t.waitingForPackages
                    : t.pendingPackages
                }}
              </p>
            </div>
          </div>

          <!-- Step 4: Processing Order (En Camino a México) -->
          <div class="flex items-start gap-4">
            <div class="relative flex-shrink-0">
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center',
                  isStatusReached('processing')
                    ? 'bg-primary-600'
                    : 'bg-gray-200',
                ]"
              >
                <svg
                  v-if="isStatusReached('processing')"
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <div
                  v-else-if="order.status === 'packages_complete'"
                  class="w-3 h-3 rounded-full bg-amber-400 animate-pulse"
                ></div>
                <div v-else class="w-3 h-3 rounded-full bg-white"></div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p
                :class="[
                  'text-sm font-medium',
                  isStatusReached('processing')
                    ? 'text-gray-900'
                    : 'text-gray-500',
                ]"
              >
                {{ t.processingOrder }}
              </p>
              <p
                :class="[
                  'text-xs mt-0.5',
                  isStatusReached('processing')
                    ? 'text-gray-600'
                    : order.status === 'packages_complete'
                    ? 'text-amber-600'
                    : 'text-gray-400',
                ]"
              >
                {{
                  isStatusReached("processing")
                    ? t.shippingToMexico
                    : order.status === "packages_complete"
                    ? t.readyToShip
                    : t.pendingProcessing
                }}
              </p>
            </div>
          </div>

          <!-- Step 5: Shipped (Enviado a México) -->
          <div class="flex items-start gap-4">
            <div class="relative flex-shrink-0">
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center',
                  isStatusReached('shipped') ? 'bg-primary-600' : 'bg-gray-200',
                ]"
              >
                <svg
                  v-if="isStatusReached('shipped')"
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <div
                  v-else-if="order.status === 'processing'"
                  class="w-3 h-3 rounded-full bg-amber-400 animate-pulse"
                ></div>
                <div v-else class="w-3 h-3 rounded-full bg-white"></div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p
                :class="[
                  'text-sm font-medium',
                  isStatusReached('shipped') ? 'text-gray-900' : 'text-gray-500',
                ]"
              >
                {{ t.shippedToMexico }}
              </p>
              <p
                v-if="order.shipped_at"
                class="text-xs text-gray-600 mt-0.5"
              >
                {{ formatDate(order.shipped_at) }}
              </p>
              <p
                v-else
                :class="[
                  'text-xs mt-0.5',
                  order.status === 'processing'
                    ? 'text-amber-600'
                    : 'text-gray-400',
                ]"
              >
                {{
                  order.status === "processing"
                    ? t.preparingShipment
                    : t.pendingShipment
                }}
              </p>
            </div>
          </div>

          <!-- Step 6: Delivered (Entregado) -->
          <div class="flex items-start gap-4">
            <div class="relative flex-shrink-0">
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center',
                  isStatusReached('delivered')
                    ? 'bg-green-600'
                    : 'bg-gray-200',
                ]"
              >
                <svg
                  v-if="isStatusReached('delivered')"
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <div
                  v-else-if="order.status === 'shipped'"
                  class="w-3 h-3 rounded-full bg-amber-400 animate-pulse"
                ></div>
                <div v-else class="w-3 h-3 rounded-full bg-white"></div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p
                :class="[
                  'text-sm font-medium',
                  isStatusReached('delivered')
                    ? 'text-gray-900'
                    : 'text-gray-500',
                ]"
              >
                {{ t.delivered }}
              </p>
              <p
                v-if="order.delivered_at"
                class="text-xs text-gray-600 mt-0.5"
              >
                {{ formatDate(order.delivered_at) }}
              </p>
              <p
                v-else
                :class="[
                  'text-xs mt-0.5',
                  order.status === 'shipped'
                    ? 'text-amber-600'
                    : 'text-gray-400',
                ]"
              >
                {{
                  order.status === "shipped"
                    ? t.inTransit
                    : t.pendingDelivery
                }}
              </p>
            </div>
          </div>

          <!-- Step 7: Awaiting Payment (Esperando Pago) -->
          <div class="flex items-start gap-4">
            <div class="relative flex-shrink-0">
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center',
                  isStatusReached('awaiting_payment')
                    ? 'bg-orange-600'
                    : 'bg-gray-200',
                ]"
              >
                <svg
                  v-if="isStatusReached('awaiting_payment')"
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <div
                  v-else-if="order.status === 'delivered'"
                  class="w-3 h-3 rounded-full bg-amber-400 animate-pulse"
                ></div>
                <div v-else class="w-3 h-3 rounded-full bg-white"></div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p
                :class="[
                  'text-sm font-medium',
                  isStatusReached('awaiting_payment')
                    ? 'text-gray-900'
                    : 'text-gray-500',
                ]"
              >
                {{ t.invoiceSent }}
              </p>
              <p
                v-if="order.quote_sent_at"
                class="text-xs text-gray-600 mt-0.5"
              >
                {{ formatDate(order.quote_sent_at) }}
              </p>
              <p
                v-else
                :class="[
                  'text-xs mt-0.5',
                  order.status === 'delivered'
                    ? 'text-amber-600'
                    : 'text-gray-400',
                ]"
              >
                {{
                  order.status === "delivered"
                    ? t.preparingInvoice
                    : t.pendingInvoice
                }}
              </p>
            </div>
          </div>

          <!-- Step 8: Payment Received (Pago Recibido) -->
          <div class="flex items-start gap-4">
            <div class="relative flex-shrink-0">
              <div
                :class="[
                  'w-8 h-8 rounded-full flex items-center justify-center',
                  isStatusReached('paid') ? 'bg-green-600' : 'bg-gray-200',
                ]"
              >
                <svg
                  v-if="isStatusReached('paid')"
                  class="w-5 h-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"
                  />
                </svg>
                <div
                  v-else-if="order.status === 'awaiting_payment'"
                  class="w-3 h-3 rounded-full bg-amber-400 animate-pulse"
                ></div>
                <div v-else class="w-3 h-3 rounded-full bg-white"></div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p
                :class="[
                  'text-sm font-medium',
                  isStatusReached('paid') ? 'text-gray-900' : 'text-gray-500',
                ]"
              >
                {{ t.paymentReceived }}
              </p>
              <p
                v-if="order.paid_at"
                class="text-xs text-gray-600 mt-0.5"
              >
                {{ formatDate(order.paid_at) }}
              </p>
              <p
                v-else
                :class="[
                  'text-xs mt-0.5',
                  order.status === 'awaiting_payment'
                    ? 'text-amber-600'
                    : 'text-gray-400',
                ]"
              >
                {{
                  order.status === "awaiting_payment"
                    ? t.waitingForPayment
                    : t.pendingPayment
                }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed } from "vue";

const props = defineProps({
  order: {
    type: Object,
    required: true,
  },
});

const user = useUser().value;
const { t: createTranslations } = useLanguage();

// Status order: collecting → awaiting_packages → packages_complete → processing → shipped → delivered → awaiting_payment → paid
const statusOrder = [
  "collecting",
  "awaiting_packages",
  "packages_complete",
  "processing",
  "shipped",
  "delivered",
  "awaiting_payment",
  "paid",
];

const isStatusReached = (targetStatus) => {
  const currentIndex = statusOrder.indexOf(props.order.status);
  const targetIndex = statusOrder.indexOf(targetStatus);
  return currentIndex >= targetIndex;
};

const formatDate = (date) => {
  if (!date) return "";
  const d = new Date(date);
  const locale = user?.preferred_language === "es" ? "es-MX" : "en-US";
  return d.toLocaleDateString(locale, {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

const translations = {
  orderProgress: {
    es: "Progreso de la Orden",
    en: "Order Progress",
  },
  itemsAdded: {
    es: "Productos Agregados",
    en: "Items Added",
  },
  itemsAddedCount: {
    es: "artículo agregado(s)",
    en: "item(s) added",
  },
  noItemsYet: {
    es: "Sin artículos aún",
    en: "No items yet",
  },
  orderCreated: {
    es: "Orden Creada",
    en: "Order Created",
  },
  packagesAtWarehouse: {
    es: "Paquetes en Almacén",
    en: "Packages at Warehouse",
  },
  allPackagesReceived: {
    es: "Todos los paquetes recibidos",
    en: "All packages received",
  },
  waitingForPackages: {
    es: "Esperando llegada de paquetes",
    en: "Waiting for packages to arrive",
  },
  pendingPackages: {
    es: "Pendiente de recepción",
    en: "Pending reception",
  },
  processingOrder: {
    es: "En Camino a México",
    en: "On Its Way to Mexico",
  },
  shippingToMexico: {
    es: "Viajando desde USA a México",
    en: "Traveling from USA to Mexico",
  },
  readyToShip: {
    es: "Listo para enviar a México",
    en: "Ready to ship to Mexico",
  },
  pendingProcessing: {
    es: "Pendiente de procesamiento",
    en: "Pending processing",
  },
  shippedToMexico: {
    es: "Enviado a tu Dirección en México",
    en: "Shipped to Your Address in Mexico",
  },
  preparingShipment: {
    es: "Preparando envío",
    en: "Preparing shipment",
  },
  pendingShipment: {
    es: "Pendiente de envío",
    en: "Pending shipment",
  },
  delivered: {
    es: "Entregado",
    en: "Delivered",
  },
  inTransit: {
    es: "En tránsito",
    en: "In transit",
  },
  pendingDelivery: {
    es: "Pendiente de entrega",
    en: "Pending delivery",
  },
  invoiceSent: {
    es: "Factura Enviada",
    en: "Invoice Sent",
  },
  preparingInvoice: {
    es: "Preparando factura",
    en: "Preparing invoice",
  },
  pendingInvoice: {
    es: "Pendiente de factura",
    en: "Pending invoice",
  },
  paymentReceived: {
    es: "Pago Recibido",
    en: "Payment Received",
  },
  waitingForPayment: {
    es: "Esperando pago",
    en: "Waiting for payment",
  },
  pendingPayment: {
    es: "Pendiente de pago",
    en: "Pending payment",
  },
  pending: {
    es: "Pendiente",
    en: "Pending",
  },
};

const t = createTranslations(translations);
</script>

<style scoped>
/* Pulse animation for active step */
@keyframes pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>